/** laydateTab v1.0 MIT License 多个laydate选择框, 依赖laydate @Author：xumi */
!function(){var isLayui=window.layui&&layui.define,ready={getPath:function(){var jsPath=document.currentScript?document.currentScript.src:function(){var js=document.scripts,last=js.length-1,src;for(var i=last;i>0;i--){if(js[i].readyState==="interactive"){src=js[i].src;break}}return src||js[last].src}();return jsPath.substring(0,jsPath.lastIndexOf("/")+1)}(),getStyle:function(node,name){var style=node.currentStyle?node.currentStyle:window.getComputedStyle(node,null);return style[style.getPropertyValue?"getPropertyValue":"getAttribute"](name)},link:function(href,fn,cssname){if(!laydateTab.path){return}var head=document.getElementsByTagName("head")[0],link=document.createElement("link");if(typeof fn==="string"){cssname=fn}var app=(cssname||href).replace(/\.|\//g,"");var id="layuicss-"+app,timeout=0;link.rel="stylesheet";link.href=laydateTab.path+href;link.id=id;if(!document.getElementById(id)){head.appendChild(link)}if(typeof fn!=="function"){return}(function poll(){if(++timeout>8*1000/100){return window.console&&console.error(id+".css: Invalid")}parseInt(ready.getStyle(document.getElementById(id),"width"))===1989?fn():setTimeout(poll,100)}())}};var lay,laydate,laydateTab={v:"1.0",config:{},path:ready.getPath,ready:function(fn){lay=window.lay;laydate=laydate?laydate:(isLayui?layui.laydate:window.laydate);var cssname="laydateTab",path="css/laydateTab.css?v="+laydateTab.v;ready.link(path,fn,cssname);return this},link:function(path,fn,cssname){ready.link(path,fn,cssname)}},MOD_NAME="laydateTab",INDEX=0,MAIN_CLASS="laydate-tab",TITLE_CLASS="laydate-tab-title",PANL_CLASS="laydate-tab-panl",SELECTED_CLASS="selected",SELECTED_CSS=".laydate-tab>ul>li.selected",FORMAT_REG_EXP="yyyy|y|MM|M|dd|d|HH|H|mm|m|ss|s",FOAMAT_REPLACE_REG={year:/(M{1,2}|d{1,2}|H{1,2}|m{1,2}|s{1,2})[^y]/g,month:/(d{1,2}|H{1,2}|m{1,2}|s{1,2})[^M]/g,date:/(H{1,2}|m{1,2}|s{1,2})[^d]/g,time:/(y{2,4}|M{1,2}|d{1,2})[^H]/g},FORMAT={year:"yyyy",month:"yyyy-MM",date:"yyyy-MM-dd",time:"HH:mm:ss",datetime:"yyyy-MM-dd HH:mm:ss"},TAB_FAST_TYPE={ymd:["year","month","date"],ym:["year","month"],md:["month","date"],all:["year","month","date","time","datetime"]},TAB_DEFUALT_TITLE={year:"年",month:"月",date:"日期",datetime:"日期时间",time:"时间"},valueToArray=function(value){return value.constructor===Array?value:[value]},getValueByArray=function(arrs,i){return typeof arrs[i]!=="undefined"?arrs[i]:arrs[0]},Class=function(options){if(!laydate){console.error("没有找到layui中laydate组件，无法进行渲染！");return}if(!options.elem){console.error("没有绑定相关的触发元素！");return}this.config=this.getDefualtConfig();for(var key in this.config){if(options[key]&&this.config[key].constructor===Array){delete this.config[key]}}this.config=lay.extend({},this.config,options);options.btns&&(this.config.btns=typeof options.btns[0]==="string"?[options.btns]:options.btns);this.elem=lay(options.elem);this._id=MOD_NAME+INDEX++;if(/^#/.test(options.theme)){var style=lay.elem("style"),styleText="#"+this._id+SELECTED_CSS+"{background: "+options.theme+"}";if("styleSheet" in style){style.setAttribute("type","text/css");style.styleSheet.cssText=styleText}else{style.innerHTML=styleText}lay("body").append(style)}typeof options.value==="string"&&(this.val(options.value),delete this.config.value);this.bindEvent()};Class.prototype.getDefualtConfig=function(){return{trigger:"click",type:TAB_FAST_TYPE.ymd}};Class.prototype.render=function(){this.creteTab()};Class.prototype.creteTab=function(){var options=this.config,targetElem=this.elem,tabElem=lay(lay.elem("div",{"class":MAIN_CLASS,id:this._id})),titleElem=this.titleElem=lay(lay.elem("ul",{"class":TITLE_CLASS})),panlElem=this.panlElem=lay(lay.elem("div",{"class":PANL_CLASS})),types=this.types=this.getTypes(options.type),typeLen=types.length,elemValue=this.isInput(targetElem[0])?targetElem[0].value:targetElem[0].innerHTML,selectedType=options.selected?options.selected:types[0],selectedType=TAB_DEFUALT_TITLE[selectedType]?selectedType:types[0],selectIndex=null;this.tabElem=tabElem;delete options.type;this.laydateObj=[];this.laydateOptions=[];for(var i=0;i<typeLen;i++){var option={},type=option.type=types[i],selectedClass=type===selectedType?{"class":SELECTED_CLASS}:null,laytitleContainer=lay(lay.elem("li",selectedClass)),laydateContainer=lay.elem("div",selectedClass);laytitleContainer[0].index=i;for(var key in options){var value=options[key],value=valueToArray(value),_thatValue=getValueByArray(value,i);_thatValue&&(option[key]=_thatValue)}laytitleContainer.html(option.title?option.title:TAB_DEFUALT_TITLE[type]);option.done=this.doneFn(option.done);option.position="static";option.elem=laydateContainer;var regExp=FOAMAT_REPLACE_REG[type],_value=elemValue||option.value,format=option.format;option.format=(format?(regExp?format.replace(regExp,""):format):FORMAT[type]).replace(/\s$/,"");if(_value&&this.isInitValue(option,_value)){option.value=_value;options.locationValueTab!==false&&(selectIndex=i)}this.laydateObj.push(laydate.render(option));titleElem.append(laytitleContainer[0]);panlElem.append(laydateContainer);this.changeEvent(option,laytitleContainer)}options.valueToSelect;tabElem.append(titleElem[0]);tabElem.append(panlElem[0]);lay("body").append(tabElem[0]);tabElem.on("click",function(e){e&&e.stopPropagation?e.stopPropagation():(e.cancelBubble=true)});selectIndex!==null&&this.changeTab(selectIndex);this.position()};Class.prototype.isInitValue=function(option,value){var that=this,formats=option.format.match(new RegExp(FORMAT_REG_EXP+"|.","g"))||[],reg="",isInitValue=false;lay.each(formats,function(i,item){var len=item.length;reg+=("("+(/y|M|d|H|m|s/.test(item)?"\\d{"+len+","+(len>2?4:2)+"}":item)+")")});reg=new RegExp("^"+reg+"$");if(option.range){var rangeStr=" "+option.range+" ",valueArr=value.split(rangeStr);value=valueArr[0];var endDate=valueArr[1];if(!reg.test(endDate)){return false}}isInitValue=reg.test(value);return isInitValue};Class.prototype.getTypes=function(type){if(this.types){return this.types}var typeArr=typeof type==="string"?TAB_FAST_TYPE[type]||[type]:type,exist={},types=[];for(var i=0,len=typeArr.length;i<len;i++){!exist[typeArr[i]]&&(exist[typeArr[i]]=true)&&types.push(typeArr[i])}return types};Class.prototype.doneFn=function(fn){var that=this;return function(value,date,endDate){that.value=value;if(typeof fn==="function"){that.value=fn(value,date,endDate)||value}that.val(that.value);that.remove()}};Class.prototype.val=function(value){var valFn=this.isInput(this.elem[0])?"val":"html";this.elem[valFn](value)};Class.prototype.isInput=function(elem){return/input|textarea/.test(elem.tagName.toLocaleLowerCase())};Class.prototype.changeEvent=function(option,titleContainer){var changeFn=option.changeTab,type=option.type,that=this;titleContainer.on("click",function(){if(!lay(this).hasClass(SELECTED_CLASS)){that.changeTab(this.index,changeFn,type)}})};Class.prototype.changeTab=function(index,changeFn,type){var titleElem=this.titleElem[0],panlElem=this.panlElem[0],panlChilds=panlElem.childNodes,titleChilds=titleElem.childNodes;for(var i=0,len=titleChilds.length;i<len;i++){var clsFn=i===index?"addClass":"removeClass";lay(titleChilds[i])[clsFn](SELECTED_CLASS);lay(panlChilds[i])[clsFn](SELECTED_CLASS)}typeof changeFn==="function"&&changeFn(type,titleChilds[index].innerHTML)};Class.prototype.bindEvent=function(){var options=this.config,elem=this.elem,that=this;elem.on(options.trigger,function(elem,bind){if(that.tabElem){return}that.render()});lay(document).on("click",function(e){if(!that.tabElem||e.target===elem[0]||e.target===that.tabElem[0]){return}that.remove()});lay(window).on("resize",function(e){that.position()});lay(document).on("scroll",function(e){that.position()})};Class.prototype.position=function(){if(!this.tabElem){return}var that=this,options=that.config,elem=that.elem[0],tabElem=that.tabElem[0],rect=elem.getBoundingClientRect(),elemWidth=tabElem.offsetWidth,elemHeight=tabElem.offsetHeight,winArea=function(type){return document.documentElement[type?"clientWidth":"clientHeight"]},margin=5,left=rect.left,top=rect.bottom;if(left+elemWidth+margin>winArea("width")){left=winArea("width")-elemWidth-margin}if(top+elemHeight+margin>winArea()){top=rect.top>elemHeight?rect.top-elemHeight:winArea()-elemHeight;top=top}tabElem.style.left=left+"px";tabElem.style.top=top+"px";typeof options.success==="function"&&options.success(tabElem,options)};Class.prototype.remove=function(render){var options=this.config;if(this.tabElem){this.tabElem.remove();this.tabElem=null;typeof options.end==="function"&&options.end(this.elem[0])}};laydateTab.render=function(options){var cls=new Class(options);return{config:cls.config}};laydateTab.ready();isLayui?(layui.define("laydate",function(exports){lay=window.lay;laydate=layui.laydate;laydateTab.path=layui.cache.dir;exports(MOD_NAME,laydateTab)})):((typeof define==="function"&&define.amd)?define(function(){return laydateTab}):function(){window.laydateTab=laydateTab}())}();